name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-packages:
    strategy:
      matrix:
        include:
          - platform: windows
            platform_tag: win_amd64
            cyz2json_platform: windows
            binary_name: cyz2Json.exe
            binary_pattern: "*.dll"
          - platform: ubuntu
            platform_tag: linux_x86_64
            cyz2json_platform: ubuntu
            binary_name: cyz2Json
            binary_pattern: "*.so"
          - platform: macos-universal
            platform_tag: macosx_11_0_arm64
            cyz2json_platform: macos
            binary_name: cyz2Json
            binary_pattern: "*.dylib"
          - platform: macos-universal
            platform_tag: macosx_10_9_x86_64
            cyz2json_platform: macos
            binary_name: cyz2Json
            binary_pattern: "*.dylib"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-python@v3
        with:
          python-version: '3.8'
      
      - name: Download cyz2json for platform
        uses: robinraju/release-downloader@v1.11
        with:
          repository: "ecotaxa/cyz2json"
          latest: true
          fileName: "cyz2json-${{ matrix.cyz2json_platform }}-latest.zip"
          out-file-path: "downloads"

      - name: Prepare package binaries
        run: |
          # Create bin directory in package
          mkdir -p src/cytosense_to_ecotaxa_pipeline/bin
          
          # Extract binaries for this platform
          unzip -j "downloads/cyz2json-${{ matrix.cyz2json_platform }}-latest.zip" \
                "${{ matrix.binary_name }}" ${{ matrix.binary_pattern }} \
                -d src/cytosense_to_ecotaxa_pipeline/bin/
          
          # Set executable permissions if not Windows
          if [ "${{ matrix.platform }}" != "windows" ]; then
            chmod +x src/cytosense_to_ecotaxa_pipeline/bin/${{ matrix.binary_name }}
          fi
          
          # List contents of bin directory
          ls -la src/cytosense_to_ecotaxa_pipeline/bin/

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools setuptools-scm

      - name: Build package
        env:
          PLATFORM_TAG: ${{ matrix.platform_tag }}
        run: |
          python -m build --wheel
          for whl in dist/*.whl; do
            new_name=$(echo $whl | sed "s/-any.whl/-${PLATFORM_TAG}.whl/")
            mv "$whl" "$new_name"
          done

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}